<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cờ Tướng Online - Trí Tuệ Việt Nam</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/game.css">
    <link rel="stylesheet" href="css/board.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <style>
        /* ========== USER MENU STYLES ========== */
        .simple-user-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            min-width: 160px;
            height: 48px;
            justify-content: space-between;
        }

        .simple-user-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .simple-user-btn.logged {
            background: linear-gradient(135deg, #48bb78, #38a169);
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
        }

        .simple-user-btn.logged:hover {
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.6);
        }

        .user-avatar-mini {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-size: 16px;
            flex-shrink: 0;
        }

        .simple-user-menu {
            position: absolute;
            background: white;
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            padding: 8px;
            min-width: 180px;
            z-index: 1000;
            display: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1), 
                        transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .simple-user-menu.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .simple-user-menu::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 20px;
            width: 16px;
            height: 16px;
            background: white;
            transform: rotate(45deg);
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            border-left: 1px solid rgba(0, 0, 0, 0.08);
            z-index: -1;
        }

        .simple-menu-item {
            width: 100%;
            padding: 12px 16px;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .simple-menu-item:hover {
            background: linear-gradient(90deg, #f7fafc 0%, #edf2f7 100%);
            color: #4299e1;
            transform: translateX(3px);
        }

        .simple-menu-item.logout {
            color: #e53e3e;
            background: linear-gradient(90deg, #fff5f5 0%, #fed7d7 100%);
        }

        .simple-menu-item.logout:hover {
            background: linear-gradient(90deg, #fed7d7 0%, #fc8181 100%);
            color: white;
        }

        .simple-menu-item i {
            width: 20px;
            font-size: 16px;
            transition: transform 0.2s ease;
        }

        .simple-menu-item:hover i {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loading-logo"><i class="fas fa-chess-king"></i></div>
        <h1>CỜ TƯỚNG ONLINE</h1>
        <p>Đang tải trải nghiệm đỉnh cao...</p>
        <div class="loading-progress"><div class="loading-progress-bar" id="loadingBar"></div></div>
        <p id="loadingText">Khởi tạo hệ thống...</p>
    </div>

    <!-- Main Header -->
    <header class="header glass-effect">
        <div class="header-left">
            <div class="logo" onclick="showTournamentLobby()">
                <div class="logo-icon"><i class="fas fa-chess-king"></i></div>
                <div class="logo-text">
                    <h1>CỜ TƯỚNG PRO</h1>
                    <span class="subtitle">Trí tuệ Việt - Đẳng cấp Quốc tế</span>
                </div>
            </div>

            <div class="quick-stats">
                <div class="stat-item"><span class="stat-value" id="onlineCount">1,234</span><span class="stat-label">Online</span></div>
                <div class="stat-item"><span class="stat-value" id="tournamentCount">12</span><span class="stat-label">Giải đấu</span></div>
                <div class="stat-item"><span class="stat-value" id="topPlayerElo">2,850</span><span class="stat-label">Top ELO</span></div>
            </div>
        </div>

        <div class="header-right">
            <!-- Simple User Menu -->
            <button id="userBtn" class="simple-user-btn" onclick="toggleUserMenu(event)">
                <div class="user-avatar-mini">
                    <i class="fas fa-user"></i>
                </div>
                <span id="userBtnText">Đăng nhập</span>
                <i class="fas fa-chevron-down"></i>
            </button>

            <div id="userMenu" class="simple-user-menu">
                <button class="simple-menu-item" id="loginMenuItem" onclick="handleSimpleLogin()">
                    <i class="fas fa-sign-in-alt"></i> Đăng nhập
                </button>
                <button class="simple-menu-item logout" id="logoutMenuItem" onclick="handleSimpleLogout()" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Đăng xuất
                </button>
            </div>

            <button class="btn btn-primary" onclick="showDailyRewards()">
                <i class="fas fa-gift"></i> Quà hàng ngày
            </button>
            <button class="btn btn-premium" onclick="showBattlePass()">
                <i class="fas fa-crown"></i> Battle Pass
            </button>
        </div>
    </header>

    <!-- Main layout -->
    <main class="main-container">
        <!-- Left Sidebar -->
        <aside class="left-sidebar">
            <div class="tournament-banner" onclick="showTournamentLobby()">
                <h3><i class="fas fa-trophy"></i> GIẢI VÔ ĐỊCH MÙA HÈ</h3>
                <p>Giải thưởng: 10,000,000 VND</p>
                <div class="tournament-timer" id="tournamentTimer">12:34:56</div>
            </div>

            <div class="sidebar-section">
                <h3><i class="fas fa-fire"></i> BẢNG XẾP HẠNG</h3>
                <div id="rankList" class="rank-list">
                    <!-- Rank items will be populated by JS -->
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3><i class="fas fa-broadcast-tower"></i> TRỰC TIẾP</h3>
                <div class="stream-list" id="streamList">
                    <!-- Stream items will be populated -->
                </div>
            </div>
            
            <div class="sidebar-section">
                <h3><i class="fas fa-users"></i> BẠN BÈ ONLINE</h3>
                <div class="friends-list" id="friendsList">
                    <!-- Friends will be populated -->
                </div>
            </div>
        </aside>

        <!-- Game Area -->
        <section class="game-area">
            <!-- Game Mode Selector -->
            <div class="game-mode-selector">
                <button class="mode-btn active" data-mode="ai" onclick="changeGameMode('ai')">
                    <i class="fas fa-robot"></i> Đấu với AI
                </button>
                <button class="mode-btn" data-mode="local" onclick="changeGameMode('local')">
                    <i class="fas fa-users"></i> 2 Người
                </button>
                <button class="mode-btn" data-mode="online" onclick="changeGameMode('online')">
                    <i class="fas fa-globe"></i> Online
                </button>
            </div>
            
            <!-- AI Level Selector (only show when AI mode) -->
            <div class="ai-level-selector" id="aiLevelSelector">
                <h4><i class="fas fa-brain"></i> Cấp độ AI</h4>
                <div class="level-buttons">
                    <button class="level-btn" data-level="1" onclick="setAILevel(1)">Dễ</button>
                    <button class="level-btn" data-level="2" onclick="setAILevel(2)">TB</button>
                    <button class="level-btn active" data-level="3" onclick="setAILevel(3)">Khá</button>
                    <button class="level-btn" data-level="4" onclick="setAILevel(4)">Khó</button>
                    <button class="level-btn" data-level="5" onclick="setAILevel(5)">Cao thủ</button>
                </div>
            </div>
            
            <!-- Online Matchmaking (only show when Online mode) -->
            <div class="matchmaking-panel" id="matchmakingPanel">
                <h4><i class="fas fa-search"></i> TÌM ĐỐI THỦ</h4>
                <div class="matchmaking-info">
                    <p>Đang tìm đối thủ phù hợp...</p>
                    <div class="elo-range">
                        <span>ELO: 1200 ± 100</span>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="startMatchmaking()">
                    <i class="fas fa-search"></i> Tìm trận
                </button>
                <button class="btn btn-secondary" onclick="cancelMatchmaking()">
                    <i class="fas fa-times"></i> Hủy
                </button>
            </div>

            <!-- Game Board Container -->
            <div class="game-board-container">
                <div class="board-header">
                    <div class="player-info red-player">
                        <div class="player-avatar">
                            <i class="fas fa-crown"></i>
                        </div>
                        <div class="player-details">
                            <span class="player-name" id="redPlayerName">Bạn (ĐỎ)</span>
                            <div class="player-stats">
                                <span class="player-elo" id="redPlayerElo">ELO: 1200</span>
                                <span class="time-display" id="redTime">10:00</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="game-status">
                        <div id="gameStatus">ĐANG CHƠI</div>
                        <div class="current-turn">
                            Lượt: <span id="currentTurn" class="red-turn">ĐỎ</span>
                        </div>
                        <div class="game-mode-display" id="gameModeDisplay">
                            <i class="fas fa-robot"></i> Đấu AI - Cấp 3
                        </div>
                    </div>
                    
                    <div class="player-info black-player">
                        <div class="player-details">
                            <span class="player-name" id="blackPlayerName">AI Cấp 3 (ĐEN)</span>
                            <div class="player-stats">
                                <span class="player-elo" id="blackPlayerElo">ELO: 1500</span>
                                <span class="time-display" id="blackTime">10:00</span>
                            </div>
                        </div>
                        <div class="player-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Chess Board -->
                <div class="chess-board-wrapper">
                    <div class="chess-board" id="chessBoard">
                        <!-- Board will be generated by JavaScript -->
                    </div>
                    <div class="board-overlay" id="boardOverlay"></div>
                </div>
                
                <!-- Game Controls -->
                <div class="game-controls">
                    <button class="btn btn-primary" onclick="newGame()">
                        <i class="fas fa-plus-circle"></i> Ván mới
                    </button>
                    <button class="btn btn-secondary" onclick="undoMove()">
                        <i class="fas fa-undo"></i> Lùi nước
                    </button>
                    <button class="btn btn-info" onclick="showHint()">
                        <i class="fas fa-lightbulb"></i> Gợi ý
                    </button>
                    <button class="btn btn-warning" onclick="offerDraw()">
                        <i class="fas fa-handshake"></i> Xin hòa
                    </button>
                    <button class="btn btn-danger" onclick="surrender()">
                        <i class="fas fa-flag"></i> Đầu hàng
                    </button>
                    <button class="btn btn-success" onclick="saveGame()">
                        <i class="fas fa-save"></i> Lưu ván
                    </button>
					
					<button class="btn btn-info" onclick="showTutorial()">
						<i class="fas fa-question-circle"></i> Hướng dẫn
					</button>

					<button class="btn btn-hint" onclick="showHint()">
						<i class="fas fa-lightbulb"></i> Gợi ý
					</button>
                    <button class="btn btn-debug" onclick="debugGame()">
    <i class="fas fa-bug"></i> Debug
</button>
                </div>
            </div>
            
            <!-- Cập nhật lại phần Captured Pieces -->
				<div class="captured-display">
					<div class="captured-section">
						<h4><i class="fas fa-skull-crossbones"></i> ĐỎ bị ăn:</h4>
						<div class="captured-pieces" id="capturedRed"></div>
					</div>
					<div class="captured-section">
						<h4><i class="fas fa-skull-crossbones"></i> ĐEN bị ăn:</h4>
						<div class="captured-pieces" id="capturedBlack"></div>
					</div>
				</div>

				<!-- Cập nhật phần Game Status -->
				<div class="game-status">
					<div id="gameStatus" class="status-text">ĐỎ ĐANG ĐI</div>
					<div class="current-turn">
						Lượt: <span id="currentTurn" class="red-turn">ĐỎ</span>
					</div>
				</div>
        </section>

        <!-- Right Sidebar -->
        <aside class="right-sidebar">
            <div class="chat-section">
                <h3><i class="fas fa-comments"></i> CHAT</h3>
                <div class="chat-messages" id="chatMessages">
                    <!-- Chat messages will be populated -->
                </div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Nhập tin nhắn...">
                    <button id="sendChatBtn" onclick="sendChatMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            
            <div class="move-history-section">
                <h3><i class="fas fa-history"></i> LỊCH SỬ NƯỚC ĐI</h3>
                <div class="move-history" id="moveHistory">
                    <!-- Move history will be populated -->
                </div>
            </div>
            
            <div class="analysis-section">
                <h3><i class="fas fa-chart-line"></i> PHÂN TÍCH</h3>
                <div class="analysis-info">
                    <div class="analysis-score" id="analysisScore">+0.0</div>
                    <div class="analysis-bar">
                        <div class="analysis-fill" id="analysisBar"></div>
                    </div>
                    <div class="advantage-text" id="advantageText">Cân bằng</div>
                </div>
            </div>
            
            <div class="tournament-section">
                <h3><i class="fas fa-trophy"></i> GIẢI ĐẤU SẮP DIỄN RA</h3>
                <div class="tournament-list" id="tournamentList">
                    <!-- Tournament list will be populated -->
                </div>
            </div>
        </aside>
    </main>

    <!-- Authentication Modals -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <span class="close-modal" onclick="hideLoginModal()">&times;</span>
            <h2><i class="fas fa-user-circle"></i> ĐĂNG NHẬP</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Tên đăng nhập</label>
                    <input id="username" type="text" placeholder="Nhập tên đăng nhập" required>
                </div>
                <div class="form-group">
                    <label for="password">Mật khẩu</label>
                    <input id="password" type="password" placeholder="Nhập mật khẩu" required>
                </div>
                <div class="form-options">
                    <label class="checkbox-label">
                        <input id="rememberMe" type="checkbox"> Ghi nhớ đăng nhập
                    </label>
                    <a href="#" onclick="showForgotPassword()">Quên mật khẩu?</a>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-sign-in-alt"></i> Đăng nhập
                    </button>
                    <button type="button" class="btn btn-secondary btn-block" onclick="showRegisterModal()">
                        <i class="fas fa-user-plus"></i> Đăng ký
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-content">
            <span class="close-modal" onclick="hideRegisterModal()">&times;</span>
            <h2><i class="fas fa-user-plus"></i> ĐĂNG KÝ</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label for="regUsername">Tên đăng nhập *</label>
                    <input id="regUsername" type="text" placeholder="Từ 3-20 ký tự" required>
                    <div class="error-message" id="usernameError"></div>
                </div>
                <div class="form-group">
                    <label for="regEmail">Email *</label>
                    <input id="regEmail" type="email" placeholder="example@email.com" required>
                    <div class="error-message" id="emailError"></div>
                </div>
                <div class="form-group">
                    <label for="regPassword">Mật khẩu *</label>
                    <input id="regPassword" type="password" placeholder="Ít nhất 6 ký tự" required>
                    <div class="password-strength">
                        <div class="strength-bar">
                            <div id="strengthFill" class="strength-fill"></div>
                        </div>
                        <div id="strengthText" class="strength-text">Độ mạnh: Yếu</div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="regConfirmPassword">Xác nhận mật khẩu *</label>
                    <input id="regConfirmPassword" type="password" placeholder="Nhập lại mật khẩu" required>
                    <div class="error-message" id="passwordError"></div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-user-plus"></i> Đăng ký
                    </button>
                    <button type="button" class="btn btn-secondary btn-block" onclick="showLoginModal()">
                        <i class="fas fa-sign-in-alt"></i> Đã có tài khoản?
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal" id="profileModal">
        <div class="modal-content">
            <span class="close-modal" onclick="hideProfileModal()">&times;</span>
            <h2><i class="fas fa-user"></i> HỒ SƠ NGƯỜI DÙNG</h2>
            <form id="profileForm">
                <div class="form-group">
                    <label for="profileDisplayName">Tên hiển thị</label>
                    <input id="profileDisplayName" type="text" placeholder="Tên hiển thị" required>
                </div>
                <div class="form-group">
                    <label for="profileEmail">Email</label>
                    <input id="profileEmail" type="email" placeholder="email@example.com" readonly>
                </div>
                <div class="form-group">
                    <label for="profileElo">ELO</label>
                    <input id="profileElo" type="number" min="0" step="1">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" id="profileSaveBtn" onclick="saveProfile()">
                        <i class="fas fa-save"></i> Lưu thay đổi
                    </button>
                    <button type="button" class="btn btn-danger" onclick="handleSimpleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Đăng xuất
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Game Result Modal -->
    <div class="modal result-modal" id="resultModal">
        <div class="modal-content">
            <div class="result-icon" id="resultIcon">
                <i class="fas fa-trophy"></i>
            </div>
            <div class="result-message" id="resultMessage">CHIẾN THẮNG!</div>
            <div class="result-details" id="resultDetails">
                Bạn đã chiến thắng sau 25 nước đi
            </div>
            <div class="result-stats">
                <div class="stat">
                    <div class="stat-value" id="resultEloChange">+15</div>
                    <div class="stat-label">Điểm ELO</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="resultCoins">+100</div>
                    <div class="stat-label">Coin</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="resultTime">10:25</div>
                    <div class="stat-label">Thời gian</div>
                </div>
            </div>
            <div class="result-actions">
                <button class="btn btn-primary" onclick="playAgain()">
                    <i class="fas fa-redo"></i> Chơi lại
                </button>
                <button class="btn btn-secondary" onclick="shareResult()">
                    <i class="fas fa-share"></i> Chia sẻ
                </button>
                <button class="btn btn-info" onclick="analyzeGame()">
                    <i class="fas fa-chart-line"></i> Phân tích
                </button>
            </div>
        </div>
    </div>

    <!-- Tournament Lobby Modal -->
    <div class="modal tournament-modal" id="tournamentModal">
        <div class="modal-content">
            <span class="close-modal" onclick="hideTournamentModal()">&times;</span>
            <h2><i class="fas fa-trophy"></i> SẢNH GIẢI ĐẤU</h2>
            <div class="tournament-grid" id="tournamentGrid">
                <!-- Tournament cards will be populated -->
            </div>
        </div>
    </div>

    <!-- Sound Controls -->
    <div class="sound-controls">
        <button class="sound-btn" id="musicBtn" onclick="toggleMusic()">
            <i class="fas fa-music"></i>
        </button>
        <button class="sound-btn" id="soundBtn" onclick="toggleSound()">
            <i class="fas fa-volume-up"></i>
        </button>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h4>VỀ CHÚNG TÔI</h4>
                <p>Cờ Tướng Online - Nơi hội tụ những kỳ thủ xuất sắc nhất Việt Nam</p>
                <div class="social-links">
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                    <a href="#"><i class="fab fa-discord"></i></a>
                </div>
            </div>
            <div class="footer-section">
                <h4>TÍNH NĂNG</h4>
                <ul>
                    <li><i class="fas fa-robot"></i> Đấu với AI 5 cấp độ</li>
                    <li><i class="fas fa-users"></i> Chơi 2 người offline</li>
                    <li><i class="fas fa-globe"></i> Đấu online PvP</li>
                    <li><i class="fas fa-trophy"></i> Giải đấu hàng tuần</li>
                </ul>
            </div>
            <div class="footer-section">
                <h4>HỖ TRỢ</h4>
                <ul>
                    <li><i class="fas fa-question-circle"></i> Hướng dẫn chơi</li>
                    <li><i class="fas fa-book"></i> Luật chơi</li>
                    <li><i class="fas fa-headset"></i> Hỗ trợ 24/7</li>
                    <li><i class="fas fa-bug"></i> Báo lỗi</li>
                </ul>
            </div>
        </div>
        <div class="copyright">© 2026 Cờ Tướng Online. Đồ án thực hành môn học - Phiên bản 4.0</div>
    </footer>

    <!-- User Menu JavaScript -->
    <script>
        // ========== SIMPLE USER MENU SYSTEM ==========
        console.log("User Menu System Loading...");

        let currentUser = null;
        let userMenuInitialized = false;

        // Toggle menu với animation
        function toggleUserMenu(event) {
            console.log("toggleUserMenu called");
            
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            const menu = document.getElementById('userMenu');
            const btn = document.getElementById('userBtn');
            
            if (!menu || !btn) {
                console.error("Menu elements not found!");
                return;
            }
            
            if (menu.classList.contains('active')) {
                // Hide menu
                menu.classList.remove('active');
                setTimeout(() => {
                    menu.style.display = 'none';
                }, 250);
            } else {
                // Show menu
                menu.style.display = 'block';
                
                // Position menu
                const rect = btn.getBoundingClientRect();
                menu.style.top = (rect.bottom + 5) + 'px';
                menu.style.right = (window.innerWidth - rect.right) + 'px';
                
                // Animate in
                setTimeout(() => {
                    menu.classList.add('active');
                }, 10);
            }
        }

        // Handle login
        function handleSimpleLogin() {
            console.log("handleSimpleLogin called");
            
            const playerName = prompt("Nhập tên người chơi:", "Kỳ thủ " + Math.floor(Math.random() * 1000));
            if (playerName && playerName.trim() !== "") {
                currentUser = {
                    name: playerName.trim(),
                    elo: 1200,
                    joined: new Date().toISOString()
                };
                
                updateUserInterface();
                
                // Save to localStorage
                localStorage.setItem('coTuongUser', JSON.stringify(currentUser));
                
                // Show notification
                if (typeof toastr !== 'undefined') {
                    toastr.success("Đăng nhập thành công! Chào mừng " + currentUser.name);
                }
                
                console.log("User logged in:", currentUser);
            }
            
            // Close menu
            toggleUserMenu();
        }

        // Handle logout
        function handleSimpleLogout() {
            console.log("handleSimpleLogout called");
            
            if (confirm("Bạn có chắc muốn đăng xuất?")) {
                currentUser = null;
                
                updateUserInterface();
                
                // Remove from localStorage
                localStorage.removeItem('coTuongUser');
                
                if (typeof toastr !== 'undefined') {
                    toastr.info("Đã đăng xuất");
                }
                
                console.log("User logged out");
            }
            
            // Close menu
            toggleUserMenu();
        }

        // Update UI based on login state
        function updateUserInterface() {
            const btnText = document.getElementById('userBtnText');
            const loginItem = document.getElementById('loginMenuItem');
            const logoutItem = document.getElementById('logoutMenuItem');
            const userBtn = document.getElementById('userBtn');
            const redPlayerName = document.getElementById('redPlayerName');
            
            if (currentUser) {
                // Logged in
                btnText.textContent = currentUser.name;
                loginItem.style.display = 'none';
                logoutItem.style.display = 'flex';
                userBtn.classList.add('logged');
                
                if (redPlayerName) {
                    redPlayerName.textContent = currentUser.name + " (ĐỎ)";
                }
            } else {
                // Logged out
                btnText.textContent = "Đăng nhập";
                loginItem.style.display = 'flex';
                logoutItem.style.display = 'none';
                userBtn.classList.remove('logged');
                
                if (redPlayerName) {
                    redPlayerName.textContent = "Bạn (ĐỎ)";
                }
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('userMenu');
            const btn = document.getElementById('userBtn');
            
            if (menu && btn && menu.classList.contains('active')) {
                if (!menu.contains(event.target) && !btn.contains(event.target)) {
                    toggleUserMenu();
                }
            }
        });

        // Close menu with ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const menu = document.getElementById('userMenu');
                if (menu && menu.classList.contains('active')) {
                    toggleUserMenu();
                }
            }
        });

        // Initialize user system
        function initializeUserSystem() {
            console.log("Initializing User System...");
            
            // Load user from localStorage
            const savedUser = localStorage.getItem('coTuongUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    console.log("Loaded user from localStorage:", currentUser);
                } catch (e) {
                    console.error("Error parsing saved user:", e);
                    localStorage.removeItem('coTuongUser');
                }
            }
            
            // Update UI
            updateUserInterface();
            
            userMenuInitialized = true;
            console.log("User System Initialized!");
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Content Loaded - Initializing User Menu");
            initializeUserSystem();
        });

        // Export functions to global scope
        window.toggleUserMenu = toggleUserMenu;
        window.handleSimpleLogin = handleSimpleLogin;
        window.handleSimpleLogout = handleSimpleLogout;
        window.initializeUserSystem = initializeUserSystem;
    </script>

    <!-- Script includes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="js/loginData.js"></script>
    <script src="js/config.js"></script>
	<script src="js/board-setup.js"></script>
	<script src="js/chess-game.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/game.js"></script>
    <script src="js/ai.js"></script>
    <script src="js/online.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/main.js"></script>
    <script src="js/hoan-chinh-co-tuong.js"></script>

    <!-- Debug script -->
    <script>
        // Debug helper
        console.log("=== CO TUONG ONLINE LOADED ===");
        console.log("User button:", document.getElementById('userBtn'));
        console.log("User menu:", document.getElementById('userMenu'));
        
        // Test function
        window.testUserMenu = function() {
            console.log("Testing user menu...");
            toggleUserMenu();
        };
    </script>
	<!-- Move Instruction Panel -->
<div id="moveInstructionPanel" class="move-instruction-panel">
    <div id="instructionContent">
        <h4><i class="fas fa-graduation-cap"></i> Hướng dẫn nước đi</h4>
        <p id="instructionText">Chọn một quân cờ để xem các nước đi có thể</p>
        <div id="pieceRules"></div>
    </div>
    <button class="btn btn-small" onclick="hideInstruction()" style="margin-top: 10px;">
        <i class="fas fa-times"></i> Đóng
    </button>
</div>

<!-- Piece Tooltip -->
<div id="pieceTooltip" class="piece-tooltip"></div>

</body>
</html>